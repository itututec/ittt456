# 版本：v1.1-251118
# 作者：ittt456
# 适用：用作Clash Party覆写模板 (DNS防泄漏）
# 备注：部分功能可选，可通过#注释或取消#注释实现是否可用，同样功能的不建议同时使用容易出问题
# 声明：仅作学习用，不得用于违法用途，不为使用后果负责
# ICON：只有大分组Icon——采用url链接的png作为Icon；没有小分组Icon——采用emoji图标形式的Icon；如果ICON都不需要可#注释掉或直接删除
# 新增：仅保留策略组和规则集内容（去掉全局设置比如DNS部分），新增细化策略组分组

# 配置策略组 共用部分的数据锚点
autosetting: &autosetting
    include-all: true
    type: url-test
    interval: 300
    tolerance: 50
proxygroup: &proxygroup
  type: select
  proxies:
    - 手动选择
    - 全部自动
    - 落地SK5
    - 自建节点
    - 自建自动
    - 香港自动
    - 狮城自动
    - 台湾自动
    - 日本自动
    - 美国自动
    - 香港节点
    - 狮城节点
    - 台湾节点
    - 日本节点
    - 其他节点
    - DIRECT
    - REJECT

## 出站策略组
proxy-groups:
  - name: 手动选择  # 手动切换和选择具体节点
    icon: https://fastly.jsdelivr.net/gh/shindgewongxj/WHATSINStash@master/icon/select.png
    type: select
    include-all: true
#    filter: "(?=.*(港|HK|(?i)Hong|Hongkong|HK))^((?!(台|日|韩|新|美|SK5|SOCKS5)).)*$"}                        # 包含节点(?=.*(港|HK|(?i)Hong|Hongkong|HK))，同时不包含节点^((?!(台|日|韩|新|美|SK5|SOCKS5)).)
    filter: "^((?!(Traffic|Expire|Premium|频道|订阅|ISP|流量|重置|到期|服|邮箱|email|国内|永久|涨价|折|优惠|交流|讨论|mby|云)).)*$"        # 不包含 到期|硬盘服|资源服... 等其他杂项节点
  - name: 默认代理  # 默认策略组/节点
    icon: https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Proxy.png
    <<: *proxygroup

### 链式代理(组)配置
## -------------------- dialer-proxy 链式代理 -------------------- ##
## a 基于关键字dialer-proxy的链式代理做法——推荐用法——也是官方最新推出的方法；
# 1.1 在proxies下添加节点时，需额外定义关键字dialer-proxy指向中继节点或中继节点组，表示通过中继节点连到落地节点；

## -------------------- relay 链式代理 -------------------- ##
## b 基于关键字relay的链式代理做法——不推荐，有很多缺点(如udp异常/grpc延迟过高等)——官方已有新方法即dialer-proxy，但relay依然可用；
# 1.1 只需在本模板文件中定义好type为relay的链式代理节点组，不需要在proxies下添加落地节点时额外定义关键字dialer-proxy信息，配置相对简单。
#  - {name: 华东中继, type: relay, proxies: [中继节点(组)名称, 落地节点(组)名称]}                              #范例基本书写格式，表示通过 中继节点(组)→→→落地节点(组)
# 👉👉👉↓↓↓以下四行是实际范例书写格式和注释说明↓↓↓
#  - {name: 落地SK5, type: select, include-all: true, filter: "(?i)链|链式代理|SK5|http|SOCKS5"}          #范例落地节点组，包含住宅SOCKS5节点
#  - {name: 华东中继, type: select, proxies: [日本自动, 台湾自动,日本节点, 台湾节点]}                       #范例华东中继组，包含JP AUTO, TW AUTO等策略组的节点
#  - {name: 华南中继, type: select, proxies: [香港自动, 狮城自动,香港节点, 狮城节点]}                       #范例华南中继组，包含HK AUTO, SG AUTO等策略组的节点
#  - {name: relay链代, type: relay, proxies: [华东中继, 落地SK5]}                                      #范例relay链式代理，表示通过 中继节点(组)EC2SK5→→→落地节点(组)LandingSK5
  # relay特别说明(参考https://clash-meta.gitbook.io/clash.meta-wiki-older/function/proxygroups/relay 和 https://merlinkodo.github.io/Clash-Rev-Doc/config/proxy-groups/relay/)：
   # 1 relay支持传输UDP，前提是代理链的头尾节点都要支持 UDP over TCP。目前支持 udp 的协议有 vmess/vless/trojan/ss/ssr/tuic/hy，不支持udp协议的是不能使用relay实现链式代理的；
   # 2 添加type为relay的代理组，且该代理组的节点顺序是，打底/中继节点(组)名称在前，落地socks5节点(组)名称在后(落地节点必须支持udp协议，设置建议打开udp为true)；
   # 3 为保证设置好的 relay链式代理 可以在clash内核的UI界面中被选择到，需要在Proxy Groups中的 手动选择组里面包含有上面定义好的 relay链式代理 名称，否则虽然定义了该链式代理，但无法在UI中选择也是白搭。

## -------------------- 中继节点组 -------------------- ##
## c 中继节点组——辅助链式代理进行使用，可以根据需要定义，也可直接使用上述现成的策略组作为中继节点组
# 华东中继组（Eastern China简写为East，包括 台湾/日本/美洲 等节点）→→→落地是去向 东亚/美洲 的住宅SK5节点
  - {name: 华东中继节点, type: select, proxies: [日本自动, 台湾自动,日本节点, 台湾节点], icon: https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/BosLife_1.png}           #手动切换华东中继策略组
#  - {name: 华东中继自动, type: url-test, include-all: true, tolerance: 50, interval: 300, icon: https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/BosLife_1.png, filter: "(?=.*(台|TW|(?i)Taiwan|TW|日|JP|(?i)Japan))^((?!(尼日利亚|港|韩|新|SK5|SOCKS5)).)*$"}          # 自动从华东中继节点中的筛选节点中选择自动测速最低的作为中继节点
# 华南中继组（Southern China简写SC，包括 香港/新加坡/欧洲 等节点），手动选择华东中继策略组→→→落地是去向 东南亚(越南/印尼/马来西亚/新加坡)/欧洲 的住宅SK5节点
  - {name: 华南中继节点, type: select, proxies: [香港自动, 狮城自动,香港节点, 狮城节点], icon: https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/BosLife_1.png}          #手动切换华南中继策略组
#  - {name: 华南中继自动, type: url-test, include-all: true, tolerance: 50, interval: 300, icon: https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/BosLife_1.png, filter: "(?=.*(港|HK|(?i)Hong|Hongkong|HK|新加坡|坡|狮城|SG|Singapore))^((?!(台|韩|日|美|SK5|SOCKS5)).)*$"}          # 自动从华南中继节点中的筛选节点中选择自动测速最低的作为中继节点

## -------------------- 其他策略组，按需定义和分类 -------------------- ##
## d 落地节点组，比如落地的ISP住宅节点（命名需带 SK5|SOCKS5|住宅 等字样）
  - {name: 落地SK5, type: select, include-all: true, filter: "(?i)链|链式代理|SK5|HTTP|SOCKS5|住宅|ISP", icon: https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/DE.png}

## e 自建节点组，包括自己部署的节点 和 获取的免费节点（免费节点命名需带 free|Free|免费 等字样 / 自建节点命名需要 pD 字样），非必选项，按需定义或配置
  - name: 自建节点
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Static.png
    filter: (?i)free|Free|免费|pD
    include-all: true
    type: select

## ↓↓↓以下策略组手动选择区域内节点↓↓↓
  - name: 香港节点
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Hong_Kong.png
    filter: (?i)香港|Hong Kong|HK|🇭🇰
    include-all: true
    type: select
  - name: 狮城节点
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Singapore.png
    filter: (?i)新加坡|Singapore|SG|🇸🇬
    include-all: true
    type: select
  - name: 台湾节点
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Taiwan.png
    filter: (?i)台湾|Taiwan|TW|🇹🇼
    include-all: true
    type: select
  - name: 日本节点
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Japan.png
    filter: (?i)日本|Japan|JP|🇯🇵
    include-all: true
    type: select
  - name: 美国节点
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/United_States.png
    filter: (?i)美国|USA|US|🇺🇸
    include-all: true
    type: select
  - name: 其他节点
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Star.png
    filter: ^((?!(广港|香港|HK|Hong Kong|🇭🇰|HongKong|广台|台湾|台灣|TW|Tai Wan|🇹🇼|🇨🇳|TaiWan|Taiwan|广日|日本|JP|川日|东京|大阪|泉日|埼玉|沪日|深日|🇯🇵|Japan|广新|新加坡|SG|坡|狮城|🇸🇬|Singapore|广美|美|US|纽约|波特兰|达拉斯|俄勒|凤凰城|费利蒙|拉斯|洛杉|圣何塞|圣克拉|西雅|芝加|🇺🇸|United States)).)*$      # 排除所列的节点/组
    include-all: true
    type: select

## ↓↓↓以下策略组自动测速自动选择节点↓↓↓
  - name: 自建自动
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Static_1.png
    filter: (?i)free|Free|免费|pD
    <<: *autosetting
  - name: 香港自动
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/HK.png
    filter: (?i)香港|Hong Kong|HK|🇭🇰
    <<: *autosetting
  - name: 狮城自动
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/SG.png
    filter: (?i)新加坡|Singapore|SG|🇸🇬
    <<: *autosetting
  - name: 台湾自动
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/TW.png
    filter: (?i)台湾|Taiwan|TW|🇹🇼
    <<: *autosetting
  - name: 日本自动
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/JP.png
    filter: (?i)日本|Japan|JP|🇯🇵
    <<: *autosetting
  - name: 美国自动
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/US.png
    filter: (?i)美国|USA|US|🇺🇸
    <<: *autosetting
  - name: 全部自动
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Auto.png
    <<: *autosetting

## ↓↓↓以下常用策略组通过手动选择节点↓↓↓
  - name: AIGC
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Bot.png
    <<: *proxygroup
  - name: TikTok
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/TikTok.png
    <<: *proxygroup
  - name: Telegram
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Telegram.png
    <<: *proxygroup
  - name: Games
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Game.png
    <<: *proxygroup
  - name: Reddit
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Reddit.svg
    <<: *proxygroup
  - name: Google
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Google_Search.png
    <<: *proxygroup
  - name: Microsoft
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Microsoft.png
    <<: *proxygroup
  - name: 漏网之鱼
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/fish.svg
    <<: *proxygroup

# ↓↓↓全局策略组↓↓↓
  - name: GLOBAL
    icon: https://fastly.jsdelivr.net/gh/itututec/ittt456@main/Icons/Global.png
    type: select
    include-all: true
    proxies:
      - 默认代理
      - 手动选择
      - 全部自动
      - 落地SK5
      - 自建自动
      - 自建节点   
      - 香港自动
      - 狮城自动
      - 台湾自动
      - 日本自动
      - 美国自动
      - 香港节点
      - 狮城节点
      - 台湾节点
      - 日本节点
      - 美国节点
      - AIGC
      - TikTok
      - Telegram
      - Reddit
      - Games
      - Microsoft
      - Google
      - DIRECT
      - REJECT      

#匹配规则
rules:
  # 1) 常见跨境平台强制走代理策略组——策略组已在rpoxy-groups中定义好
  - RULE-SET,net-check,默认代理
  - RULE-SET,GoogleCNProxy,默认代理
  - RULE-SET,bing,AIGC
  - RULE-SET,copilot,AIGC
  - RULE-SET,bard,AIGC
  - RULE-SET,openai,AIGC
  - RULE-SET,claude,AIGC
  - RULE-SET,metaai,AIGC
  - RULE-SET,perplexity,AIGC
  - RULE-SET,microsoft,Microsoft
  - RULE-SET,steam,Games
  - RULE-SET,EA,Games
  - RULE-SET,Reddit,Reddit 
  - RULE-SET,tiktok_domain,TikTok
  - RULE-SET,telegram_domain,Telegram
  - RULE-SET,telegram_ip,Telegram,no-resolve
  - RULE-SET,google_domain,Google
  - RULE-SET,google_ip,Google,no-resolve
  - RULE-SET,gfw_domain,默认代理
  - RULE-SET,geolocation-!cn,默认代理,no-resolve

  # 2) 本地直连
  - RULE-SET,private_domain,DIRECT
  - IP-CIDR,127.0.0.0/8,DIRECT   

  # 3) 国内直连
  - RULE-SET,perdirect_domain,DIRECT
  - RULE-SET,cn_domain,DIRECT
  - RULE-SET,cn_ip,DIRECT,no-resolve
  - GEOIP,CN,DIRECT,no-resolve

  # 4) 其他流量默认走代理/兜底设置
  - MATCH,漏网之鱼

# 规则集定义
## type：可选http/file/inline；  behavior：可选domain/ipcidr/classical；  format：可选yaml/text/mrs/list

# 配置规则集 共用部分的数据锚点
## 数据引用——避免重复输入：& 锚点和 * 别名，可以用来引用，& 用来建立锚点，<<表示合并到当前数据，* 用来引用锚点——如合并时有重复的项，则不会去合并
## 数据引用官方文档：https://merlinkodo.github.io/Clash-Rev-Doc/config/#_8
rule-anchor:
  ip: &ip {type: http, interval: 86400, behavior: ipcidr, format: mrs}                # 建立名为 ip 的数据锚点
  domain: &domain {type: http, interval: 86400, behavior: domain, format: yaml}        # 建立名为 domain 的数据锚点
  class: &class {type: http, interval: 86400, behavior: classical, format: text}      # 建立名为 clashh 的数据锚点

rule-providers:
  # 简化后格式——引用锚点数据，简单明了
  net-check: { <<: *class, url: "https://hub.gitmirror.com/https://raw.githubusercontent.com/itututec/ittt456/refs/heads/main/miho-config/net-check.list"}
  GoogleCNProxy: { <<: *class, url: "https://hub.gitmirror.com/https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/GoogleCNProxyIP.list"}
  perdirect_domain: { <<: *class, url: "https://hub.gitmirror.com/https://raw.githubusercontent.com/itututec/ittt456/refs/heads/main/perlist/perdirect_domain.list"}
  private_domain: { <<: *domain, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/private.yaml"}
  cn_domain: { <<: *domain, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/cn.yaml"} 
  tiktok_domain: { <<: *domain, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/tiktok.yaml"}
  telegram_domain: { <<: *domain, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/telegram.yaml"}
  microsoft: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/microsoft.yaml"}
  google_domain: { <<: *domain, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google.yaml"}
  gfw_domain: { <<: *domain, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/gfw.yaml"}
  geolocation-!cn: { <<: *domain, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/geolocation-!cn.yaml"}
  cn_ip: { <<: *ip, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.yaml"}
  telegram_ip: { <<: *ip, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/telegram.yaml"}
  google_ip: { <<: *ip, url: "https://ghfast.top/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/google.yaml"}
  bing: { <<: *class, url: "https://ghfast.top/https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Bing/Bing.yaml"}
  copilot: { <<: *class, url: "https://ghfast.top/https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Copilot/Copilot.yaml"}
  claude: { <<: *class, url: "https://ghfast.top/https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Claude/Claude.yaml"}
  bard: { <<: *class, url: "https://ghfast.top/https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/BardAI/BardAI.yaml"}
  openai: { <<: *class, url: "https://ghfast.top/https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.yaml"}
  metaai: {<<: *class, url: "https://gh-proxy.com/raw.githubusercontent.com/liandu2024/clash/refs/heads/main/list/MetaAi.list"}
  perplexity: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/perplexity.yaml"}
  Reddit: {<<: *domain, url: "https://gh-proxy.com/github.com/metacubex/meta-rules-dat/raw/refs/heads/meta/geo/geosite/reddit.yaml"}
  EA: {<<: *class, url: "https://gh-proxy.com/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/EA/EA.yaml"}
  steam: { <<: *class, url: "https://ghfast.top/https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam.yaml"}
